# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy store
on:
   pull_request:
      branches:
         - main

env:
   NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
   GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
   on_merge_master:
      runs-on: ubuntu-latest
      steps:
         - name: checkout
           uses: actions/checkout@v4
           with:
              fetch-depth: 2;

         - uses: actions/setup-node@v4
           name: Setup .npmrc file to publish to npm
           with:
              node-version: "20.x"
              registry-url: "https://registry.npmjs.org"
              # Defaults to the user or organization that owns the workflow file
              scope: "@octocat"
              cache: "yarn"
         - name: Cache Yarn Dependencies
           uses: actions/cache@v4
           with:
              path: ~/.yarn-cache # Yarn's global cache directory
              key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
              restore-keys: |
                 yarn-${{ runner.os }}-

         - name: check if core package changed
           id: core-check
           run: |
              if git diff --quiet HEAD~1 HEAD -- packages/core/; then
              echo "CORE_CHANGE=false" >> $GITHUB_OUTPUT
              else
              echo "CORE_CHANGE=true" >> $GITHUB_OUTPUT
              fi

         - name: publich core package
           if: steps.core-check.outputs.CORE_CHANGE == 'true'
           run: |
              echo "open core package folder"
              cd packages/core
              echo "install"
              yarn --ignore-engines
              echo "publish"
              yarn publish
           env:
              NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

         - name: build store
           run: |
              cd apps/store 
              VITE_STORE_VERSION=$(jq -r .version package.json)
              echo "VITE_STORE_VERSION=$VITE_STORE_VERSION" > .env
              echo "The package version is $VITE_STORE_VERSION"
              echo -e "\033[1;34mINSTALL"
              yarn install --frozen-lockfile --ignore-engines
              echo -e "\033[1;34mBUILD"
              yarn build

         - name: deploy store to firebase hosting
           uses: FirebaseExtended/action-hosting-deploy@v0
           with:
              repoToken: ${{ secrets.GITHUB_TOKEN }}
              firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSDEV_STORES_PROD }}
              channelId: live
              projectId: jsdev-stores-prod
              entryPoint: apps/store
           env:
              FIREBASE_CLI_EXPERIMENTS: webframeworks
   test:
      timeout-minutes: 60
      runs-on: ubuntu-latest
      steps:
         - uses: actions/checkout@v4
         - uses: actions/setup-node@v4
           with:
              node-version: lts/*
         - name: Install dependencies
           run: npm install -g yarn && yarn
         - name: Install Playwright Browsers
           run: yarn playwright install --with-deps
         - name: Run Playwright tests
           run: yarn playwright test
         - uses: actions/upload-artifact@v4
           if: ${{ !cancelled() }}
           with:
              name: playwright-report
              path: playwright-report/
              retention-days: 30
